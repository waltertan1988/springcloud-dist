#!/usr/bin/env groovy
import groovy.transform.Field;

properties([gitLabConnection(''), [$class: 'RebuildSettings', autoRebuild: false, rebuildDisabled: false], buildDiscarder(logRotator(artifactDaysToKeepStr: '', artifactNumToKeepStr: '', daysToKeepStr: '', numToKeepStr: '5'))])

@Field final def GITHUB_REPO = 'https://github.com/waltertan1988/springcloud-dist.git'
@Field final def DOCKER_REGISTRY = 'centos7-tools:5000'
@Field final def MAVEN_TOOL = 'maven3.2.3'
@Field final def INFO_FORMAT = "[INFO] %s"

node {
	final def DOCKER_FILE_FOLDER = "${env.WORKSPACE}/${MODULE}/docker${env.BUILD_NUMBER}"
    final def IMAGE_NAME_WITH_TAG = "${DOCKER_REGISTRY}/${MODULE}:latest"
    final def SERVICE_PORT = '7110'
    
	try {
		stage('SCM Checkout') {
			checkout([$class: 'GitSCM', branches: [[name: "${BRANCH}"]], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: 'github', url: GITHUB_REPO]]])
		}

		stage('Maven Build') {
			final def MAVEN_HOME = tool "${MAVEN_TOOL}"
			sh script: "${MAVEN_HOME}/bin/mvn -f ${env.WORKSPACE}/${MODULE} clean package -Dmaven.test.skip=true"
		}
		
		stage('Docker Image Build'){
			final def BUILD_VERSION = getXmlValue("${env.WORKSPACE}/${MODULE}/pom.xml",'</version>')
			
			sh script: """
				mkdir ${DOCKER_FILE_FOLDER}
				cp ${env.WORKSPACE}/Dockerfile ${DOCKER_FILE_FOLDER}
				cp ${env.WORKSPACE}/${MODULE}/target/${MODULE}-${BUILD_VERSION}.jar ${DOCKER_FILE_FOLDER}
			"""
		
			def existingImageCount = sh returnStdout: true, script: "sudo /usr/bin/docker image ls | grep ${MODULE} | wc -l"
			if(existingImageCount.toInteger() > 0){
				stopAndDeleteDockerContainer(IMAGE_NAME_WITH_TAG)
			    sh returnStatus: true, script: "sudo /usr/bin/docker image rm ${IMAGE_NAME_WITH_TAG}"
			}else{
				info("No need to clear image ${IMAGE_NAME_WITH_TAG}")
			}
			
			sh script: """
				sudo /usr/bin/docker build \
				-t ${IMAGE_NAME_WITH_TAG} \
				--build-arg jarFile=${MODULE}-${BUILD_VERSION}.jar \
				--build-arg port=${SERVICE_PORT} \
				${DOCKER_FILE_FOLDER}
			"""
		}
		
		stage('Docker Image Push'){
			// 上传镜像
		}
		
		stage('Deployment'){
			// 部署
		}

		currentBuild.result = "SUCCESS"
	} catch (e) {
		println e.getMessage()
		currentBuild.result = "FAILURE"
	} finally{
		sh script: "rm -rf ${DOCKER_FILE_FOLDER}"
	}
}

def getXmlValue(xml, tag){
	def value = sh returnStdout: true, script: "cat ${xml} | grep '${tag}' | awk -F '>' '{print \$2}'| awk -F '<' '{print \$1}' | tr '\\n' ' '"
	return value.trim()
}

//TODO 这里要改为同时支持根据imageId来停止和删除
def stopAndDeleteDockerContainer(imageNameWithTag){
	final def splitter = '|'
	def containerIdStr = sh returnStdout: true, script: "sudo /usr/bin/docker ps -a | grep '${imageNameWithTag}' | awk -F ' ' '{print \$1}' | tr '\\n' '${splitter}'"
	
	echo ">>>>>>>containerIdStr=${containerIdStr}"
	if(containerIdStr!=null && containerIdStr!=''){
		for(String cid : containerIdStr.split("\\${splitter}")){
			info("stop and remove existing container: ${cid}")
			sh returnStatus: true, script: "sudo /usr/bin/docker container stop ${cid}"
			sh returnStatus: true, script: "sudo /usr/bin/docker container rm ${cid}"
		}
	}
}

@NonCPS
def info(msg){
	return println(String.format(INFO_FORMAT, msg))
}